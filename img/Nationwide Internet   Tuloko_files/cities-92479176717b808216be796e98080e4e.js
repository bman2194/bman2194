function pagination(){$("#static-results-container").delegate("span a","click",function(e){url=$(this).attr("href"),e.preventDefault(),window.location.hash=url,$.ajax({url:url,type:"GET",data:url,success:function(e){$("#server-search-results").empty().append(e),setupMap()},error:function(e,t,s){console.log(e),console.log(t),console.log(s)},dataType:"html"})})}function initEventResultsCategories(){$("#static-results-container").delegate(".event-cat","click",function(){console.log("need category id")})}function initClearAll(){$("#static-results-container").delegate(".clear-all","click",function(){var e=$(this).siblings(".terms-list").hasClass("business-terms");clearAll(e)})}function clearAll(e){e?$("#business-filter-terms").empty():($("#event-filter-terms").empty(),$("#event-filter-terms-wrapper").hide()),resetFilters(e)}function resetFilters(e){if(e)var t=$("#businesses-aside");else var t=$("#events-aside");var s=t.find(".double-level"),a=t.find(".single-level");s.find(".selected").removeClass("selected"),s.find(".children-selected").removeClass("children-selected"),s.find(".sub-selected").removeClass("sub-selected"),a.find(".selected").removeClass("selected"),t.find("input[type=checkbox]").prop("checked",!1),t.find(".hidden-search-term").remove(),setResults(e)}function initDeleteTerm(){$("#static-results-container").delegate(".terms-wrapper li","click",function(){var e=$(this),t=e.hasClass("search-term"),s=e.parents(".terms-list").hasClass("business-terms");t?removeSearchTerm(e,s):deselectFilter(e,s),setResults(s)})}function deselectFilter(e,t){var s=$("#"+e.attr("id").slice(0,-5));s.parents(".single-level").length?(s.removeClass("selected"),s.find("input[type=checkbox]").prop("checked",!1),e.remove(),t||0!=$("#event-filter-terms li").length||$("#event-filter-terms-wrapper").hide()):s.parents(".subcategories").length?deselectSubcategory(s,s.parents(".top-cat"),t,!1):s.parents(".double-level").length&&deselectTopCategory(s,t)}function deselectSubcategory(e,t,s,a){e.removeClass("sub-selected"),removeTerm(e.attr("id")+"_term"),s||0!=$("#event-filter-terms li").length||$("#event-filter-terms-wrapper").hide(),e.find("input[type=checkbox]").prop("checked",!1);var r=0,i=e.siblings();i.each(function(e,t){var s=$(t).eq(e);s.hasClass("sub-selected")&&r++}),0==r&&a?(t.removeClass("children-selected").addClass("selected"),addTerm(t.attr("id")+"_term",t.find(".cat .term-name").text(),s),t.find(".cat input[type=checkbox]").prop("checked",!0)):0==r&&t.removeClass("children-selected")}function deselectTopCategory(e,t){e.removeClass("selected").removeClass("children-selected"),removeTerm(e.attr("id")+"_term"),t||0!=$("#event-filter-terms li").length||$("#event-filter-terms-wrapper").hide(),e.find(".cat input[type=checkbox]").prop("checked",!1);var s=e.find(".sub-selected");s.each(function(e,t){var t=$(t);removeTerm(t.attr("id")+"_term"),t.find("input[type=checkbox]").prop("checked",!1)}),s.removeClass("sub-selected")}function initTabs(){$("#main-tabs").delegate(".tab","click",function(){showTab($(this))})}function showTab(e){var t=$("#"+e.attr("id").slice(0,-4));$("#main-tabs").find(".tab").removeClass("selected"),e.addClass("selected"),$(".results").css("height","0px").css("margin-top","0").css("overflow","hidden"),t.css("display","inline-block").css("height","auto").css("margin-top","50px").css("overflow","visible"),"businesses-tab"==e.attr("id")?($("#browse-type").text("Businesses"),$(".search-wrapper").show(),$("#search").attr("placeholder","e.g. Restaurant"),$("#server-search-results").children().length&&$("#map-wrapper").addClass("visible")):"events-tab"==e.attr("id")?($("#map-wrapper").removeClass("visible"),$("#browse-type").text("Events"),$(".search-wrapper").show(),$("#search").attr("placeholder","e.g. Event"),$("#server-events-results").children().length||getResults($("#events-form"))):($("#browse-type").text("News"),$(".search-wrapper").hide())}function initSeeAll(){$("#static-results-container").delegate(".see-all-button","click",function(){var e=$(this),t=e.siblings(".double-level"),s=t.find(".secondary-cat");e.hasClass("expanded")?(e.removeClass("expanded").find(".text").text("See All"),s.slideUp(300)):(e.addClass("expanded").find(".text").text("See Fewer"),s.slideDown(300))})}function initSingleLevelFilters(){$("#static-results-container").delegate(".single-level li","click",function(){var e=$(this),t=e.parents(".main-aside").hasClass("businesses-aside");e.hasClass("selected")?(e.removeClass("selected"),removeTerm(e.attr("id")+"_term"),e.find("input[type=checkbox]").prop("checked",!1)):(e.addClass("selected"),addTerm(e.attr("id")+"_term",e.find(".term-name").text(),t),e.find("input[type=checkbox]").prop("checked",!0)),setResults(t)})}function initDoubleLevelFilters(){$("#static-results-container").delegate(".cat","click",function(){var e=$(this).parents(".top-cat"),t=$(this).parents(".main-aside").hasClass("businesses-aside");e.hasClass("selected")||e.hasClass("children-selected")?deselectTopCategory(e,t):(e.addClass("selected"),addTerm(e.attr("id")+"_term",e.find(".cat .term-name").text(),t),e.find(".cat input[type=checkbox]").prop("checked",!0)),setResults(t)}),$("#static-results-container").delegate(".subcategories li","click",function(){var e=$(this),t=e.parents(".top-cat"),s=$(this).parents(".main-aside").hasClass("businesses-aside");e.hasClass("sub-selected")?deselectSubcategory(e,t,s,!0):(e.addClass("sub-selected"),addTerm(e.attr("id")+"_term",e.find(".term-name").text(),s),e.find("input[type=checkbox]").prop("checked",!0),t.hasClass("selected")&&(t.removeClass("selected").addClass("children-selected"),removeTerm(t.attr("id")+"_term"),t.find(".cat input[type=checkbox]").prop("checked",!1))),setResults(s)})}function initTopSearch(){$("#top-search").submit(function(){var e=$("#businesses-tab").hasClass("selected"),t=$(this).find("input[type=text]");return isBlank(t.val())||addSearchTerm(t,e),t.removeClass("filled"),!1}),$("#search").blur(function(){isBlank($(this).val())?$(this).removeClass("filled"):$(this).addClass("filled")})}function initAsideSearch(){$("#search_aside_input").blur(function(){return asideChange(),!1}).keypress(function(e){var t=e.keyCode?e.keyCode:e.which;return 13==t?(asideChange(),!1):void 0}),$("#businesses-form").submit(function(){return asideChange(),!1})}function asideChange(){var e=$("#businesses-tab").hasClass("selected");isBlank($("#search_aside_input").val())||addSearchTerm($("#search_aside_input"),e)}function initPopular(){$("#popular").delegate(".see-all","click",function(){var e="#"+$(this).data("cat-id");catObj=$(e),catObj.addClass("selected"),addTerm(catObj.attr("id")+"_term",catObj.find(".cat .term-name").text(),!0),catObj.find(".cat input[type=checkbox]").prop("checked",!0),setResults(!0)})}function stripVal(e){return e.replace(/[^\w\s]/gi,"")}function addSearchTerm(e,t){var s=e.val(),a=stripVal(s);e.val("");var r="<li class='search-term'><span class='value'>"+s+"</span> <span class='close-term'></span></li>",i="<input type='hidden' class='hidden-search-term "+a+"' value='"+s+"' name='keywords' />";if(t){var n=$("#business-filter-terms"),o=$("#businesses-form"),l=n.find(".search-term");l.length&&removeSearchTerm(l.eq(0),t),n.append(r),o.append(i)}else{var n=$("#event-filter-terms"),o=$("#events-form"),l=n.find(".search-term");l.length&&removeSearchTerm(l.eq(0),t),n.append(r),$("#event-filter-terms-wrapper").show(),o.append(i)}setResults(t)}function removeSearchTerm(e,t){var s=stripVal(e.find(".value").text());t?$("#businesses-form").find("."+s).remove():($("#events-form").find("."+s).remove(),1==$("#event-filter-terms li").length&&$("#event-filter-terms-wrapper").hide()),e.remove()}function addTerm(e,t,s){var a="<li id='"+e+"'>"+t+" <span class='close-term'></span></li>";s?$("#business-filter-terms").append(a):($("#event-filter-terms").append(a),$("#event-filter-terms-wrapper").show())}function removeTerm(e){$("#"+e).remove()}function resetSearchResults(){$("#server-search-results").empty(),window.location.hash=$("#businesses-form").serialize()}function setResults(e){if(e){var t=$("#business-filter-terms"),s=t.find("li");0==s.length?(resetSearchResults(),showPopularTours()):(showSearchResults(),getResults($("#businesses-form")))}else getResults($("#events-form"));hideMobileMenu(e)}function hideMobileMenu(e){if(e)var t=$("#businesses-aside");else var t=$("#events-aside");$("#mobile-search-trigger").removeClass("active"),t.hide(),$("#main-tabs").show()}function getResults(e){var t=e.serialize();window.location.hash=t,$.ajax({url:e.attr("action")+".xml",type:"GET",data:t,success:function(t){"businesses-form"==e.attr("id")?($("#server-search-results").empty().append(t),setupMap()):$("#server-events-results").empty().append(t)},error:function(e,t,s){console.log(e),console.log(t),console.log(s)},dataType:"html"})}function setupMap(){var e=$("#server-search-results").find("li"),t=[],s=$("#server-search-results").find("li.local").length;0==e.length?$("#map-wrapper").removeClass("visible"):e.each(function(e,a){var r=$(a),i=r.find(".place_dom").html(),n=r.find(".result_latitude").val(),o=r.find(".result_longitude").val(),l=r.find(".result_address").val();if(r.hasClass("local"))if(isBlank(n)||isBlank(o)||0==parseInt(n)){var p=new google.maps.Geocoder;p.geocode({address:l},function(a,r){if(r==google.maps.GeocoderStatus.OK){var n=a[0].geometry.location;t.push([i,n.lat(),n.lng(),e]),s--,0==s&&showMap(t)}else s--,0==s&&showMap(t)})}else t.push([i,parseFloat(n),parseFloat(o),e]),s--,0==s&&showMap(t)})}function showMap(e){var t=new google.maps.LatLngBounds;for(r=0;r<e.length;r++)t.extend(new google.maps.LatLng(e[r][1],e[r][2]));$("#map-wrapper").addClass("visible");var s=new google.maps.Map(document.getElementById("map_div"),{zoom:12,center:t.getCenter(),mapTypeId:google.maps.MapTypeId.ROADMAP,scrollwheel:!1});s.fitBounds(t);var a,r,i=new google.maps.InfoWindow({maxWidth:300});for(r=0;r<e.length;r++)a=new RichMarker({position:new google.maps.LatLng(e[r][1],e[r][2]),map:s,content:'<div class="map-marker"><p>'+(parseInt(e[r][3])+1)+"</p></div>",flat:!0,anchorPoint:new google.maps.Point(0,-46)}),google.maps.event.addListener(a,"click",function(t,a){return function(){i.setContent(e[a][0]),i.open(s,t),$(".map-marker").removeClass("selected"),$(event.target).parents(".map-marker").addClass("selected")}}(a,r));google.maps.event.addListener(i,"closeclick",function(){$(".map-marker").removeClass("selected")})}function crackUrl(){var e=window.location.hash,t=e.slice(1).split("&");$("#travelers_autocomplete").val("1");for(var s=[],a=[],r=null,i=!0,n="businesses",o=0;o<t.length;o++){var l=t[o].split("="),p=decodeURIComponent(l[0]);"areas[]"!=p||isBlank(l[1])?"categories[]"!=p||isBlank(l[1])?"keywords"!=p||isBlank(l[1])?(p="result_type")&&"events"==l[1]&&(i=!1,n="events"):r=decodeURI(l[1]):a.push(l[1]):s.push(l[1])}var c=$("#"+n),d=c.find(".main-aside");if(null!=r){var h=r,g=stripVal(h),u="<li class='search-term'><span class='value'>"+h+"</span> <span class='close-term'></span></li>",m="<input type='hidden' class='hidden-search-term "+g+"' value='"+h+"' name='keywords' />";i?($("#business-filter-terms").append(u),$("#businesses-form").append(m)):($("#event-filter-terms").append(u),$("#event-filter-terms-wrapper").show(),$("#events-form").append(m))}if(i){for(var o=0;o<a.length;o++){var f=a[o],v="#"+f.replace(/^A-Za-z0-9/,""),y=$(v);y.parents(".subcategories").length?(y.parents(".top-cat").addClass("children-selected"),y.addClass("sub-selected"),addTerm(y.attr("id")+"_term",y.find(".term-name").text(),i),y.find("input[type=checkbox]").prop("checked",!0)):(y.addClass("selected"),addTerm(y.attr("id")+"_term",y.find(".cat .term-name").text(),i),y.find(".cat input[type=checkbox]").prop("checked",!0))}for(var o=0;o<s.length;o++){var b=d.find("."+s[o].replace(/^A-Za-z0-9/,""));b.addClass("selected"),addTerm(b.attr("id")+"_term",b.find(".term-name").text(),i),b.find("input[type=checkbox]").prop("checked",!0)}}else{for(var o=0;o<a.length;o++){var w=$("#"+a[o]);w.addClass("selected"),addTerm(a[o]+"_term",w.find(".term-name").text(),i),w.find("input[type=checkbox]").prop("checked",!0)}showTab($("#events-tab"))}setResults(i)}function showSearchResults(){$("#popular").hide(),$("#search-aside").show(),$("#search-results").show()}function showPopularTours(){$("#search-results").hide(),$("#search-aside").hide(),$("#popular").show(),$("#map-wrapper").removeClass("visible")}!function(){function e(e){var t=e||{};this.d=this.c=g,void 0==e.visible&&(e.visible=h),void 0==e.shadow&&(e.shadow="7px -3px 5px rgba(88,88,88,0.7)"),void 0==e.anchor&&(e.anchor=u.BOTTOM),this.setValues(t)}function t(e,t){var s=document.createElement("DIV");if(s.innerHTML=t,1==s.childNodes.length)return s.removeChild(s.firstChild);for(var a=document.createDocumentFragment();s.firstChild;)a.appendChild(s.firstChild);return a}function s(e,t){if(t)for(var s;s=t.firstChild;)t.removeChild(s)}function a(e,t){if(e.c){var s="";-1!==navigator.userAgent.indexOf("Gecko/")?("dragging"==t&&(s="-moz-grabbing"),"dragready"==t&&(s="-moz-grab")):("dragging"==t||"dragready"==t)&&(s="move"),"draggable"==t&&(s="pointer"),e.a.style.cursor!=s&&(e.a.style.cursor=s)}}function r(e,t){if(e.getDraggable()&&!e.d){e.d=h;var s=e.getMap();e.m=s.get("draggable"),s.set("draggable",g),e.h=t.clientX,e.i=t.clientY,a(e,"dragready"),e.a.style.MozUserSelect="none",e.a.style.KhtmlUserSelect="none",e.a.style.WebkitUserSelect="none",e.a.unselectable="on",e.a.onselectstart=function(){return g},p(e),google.maps.event.trigger(e,"dragstart")}}function i(e){e.getDraggable()&&e.d&&(e.d=g,e.getMap().set("draggable",e.m),e.h=e.i=e.m=null,e.a.style.MozUserSelect="",e.a.style.KhtmlUserSelect="",e.a.style.WebkitUserSelect="",e.a.unselectable="off",e.a.onselectstart=function(){},c(e),a(e,"draggable"),google.maps.event.trigger(e,"dragend"),e.draw())}function n(e,t){if(e.getDraggable()&&e.d){var s=e.h-t.clientX,r=e.i-t.clientY;e.h=t.clientX,e.i=t.clientY,s=parseInt(e.a.style.left,10)-s,r=parseInt(e.a.style.top,10)-r,e.a.style.left=s+"px",e.a.style.top=r+"px";var n=d(e);e.setPosition(e.getProjection().fromDivPixelToLatLng(new google.maps.Point(s-n.width,r-n.height))),a(e,"dragging"),google.maps.event.trigger(e,"drag")}else i(e)}function o(e){e.f&&(google.maps.event.removeListener(e.f),delete e.f),a(e,"")}function l(e,t){t&&(e.f=google.maps.event.addDomListener(t,"mousedown",function(t){r(e,t)}),a(e,"draggable"))}function p(e){e.a.setCapture?(e.a.setCapture(h),e.e=[google.maps.event.addDomListener(e.a,"mousemove",function(t){n(e,t)},h),google.maps.event.addDomListener(e.a,"mouseup",function(){i(e),e.a.releaseCapture()},h)]):e.e=[google.maps.event.addDomListener(window,"mousemove",function(t){n(e,t)},h),google.maps.event.addDomListener(window,"mouseup",function(){i(e)},h)]}function c(e){if(e.e){for(var t,s=0;t=e.e[s];s++)google.maps.event.removeListener(t);e.e.length=0}}function d(e){var t=e.l();if("object"==typeof t)return t;var s=new google.maps.Size(0,0);if(!e.b)return s;var a=e.b.offsetWidth;switch(e=e.b.offsetHeight,t){case u.TOP:s.width=-a/2;break;case u.TOP_RIGHT:s.width=-a;break;case u.LEFT:s.height=-e/2;break;case u.MIDDLE:s.width=-a/2,s.height=-e/2;break;case u.RIGHT:s.width=-a,s.height=-e/2;break;case u.BOTTOM_LEFT:s.height=-e;break;case u.BOTTOM:s.width=-a/2,s.height=-e;break;case u.BOTTOM_RIGHT:s.width=-a,s.height=-e}return s}var h=!0,g=!1;e.prototype=new google.maps.OverlayView,window.RichMarker=e,e.prototype.getVisible=function(){return this.get("visible")},e.prototype.getVisible=e.prototype.getVisible,e.prototype.setVisible=function(e){this.set("visible",e)},e.prototype.setVisible=e.prototype.setVisible,e.prototype.s=function(){this.c&&(this.a.style.display=this.getVisible()?"":"none",this.draw())},e.prototype.visible_changed=e.prototype.s,e.prototype.setFlat=function(e){this.set("flat",!!e)},e.prototype.setFlat=e.prototype.setFlat,e.prototype.getFlat=function(){return this.get("flat")},e.prototype.getFlat=e.prototype.getFlat,e.prototype.p=function(){return this.get("width")},e.prototype.getWidth=e.prototype.p,e.prototype.o=function(){return this.get("height")},e.prototype.getHeight=e.prototype.o,e.prototype.setShadow=function(e){this.set("shadow",e),this.g()},e.prototype.setShadow=e.prototype.setShadow,e.prototype.getShadow=function(){return this.get("shadow")},e.prototype.getShadow=e.prototype.getShadow,e.prototype.g=function(){this.c&&(this.a.style.boxShadow=this.a.style.webkitBoxShadow=this.a.style.MozBoxShadow=this.getFlat()?"":this.getShadow())},e.prototype.flat_changed=e.prototype.g,e.prototype.setZIndex=function(e){this.set("zIndex",e)},e.prototype.setZIndex=e.prototype.setZIndex,e.prototype.getZIndex=function(){return this.get("zIndex")},e.prototype.getZIndex=e.prototype.getZIndex,e.prototype.t=function(){this.getZIndex()&&this.c&&(this.a.style.zIndex=this.getZIndex())},e.prototype.zIndex_changed=e.prototype.t,e.prototype.getDraggable=function(){return this.get("draggable")},e.prototype.getDraggable=e.prototype.getDraggable,e.prototype.setDraggable=function(e){this.set("draggable",!!e)},e.prototype.setDraggable=e.prototype.setDraggable,e.prototype.k=function(){this.c&&(this.getDraggable()?l(this,this.a):o(this))},e.prototype.draggable_changed=e.prototype.k,e.prototype.getPosition=function(){return this.get("position")},e.prototype.getPosition=e.prototype.getPosition,e.prototype.setPosition=function(e){this.set("position",e)},e.prototype.setPosition=e.prototype.setPosition,e.prototype.q=function(){this.draw()},e.prototype.position_changed=e.prototype.q,e.prototype.l=function(){return this.get("anchor")},e.prototype.getAnchor=e.prototype.l,e.prototype.r=function(e){this.set("anchor",e)},e.prototype.setAnchor=e.prototype.r,e.prototype.n=function(){this.draw()},e.prototype.anchor_changed=e.prototype.n,e.prototype.setContent=function(e){this.set("content",e)},e.prototype.setContent=e.prototype.setContent,e.prototype.getContent=function(){return this.get("content")},e.prototype.getContent=e.prototype.getContent,e.prototype.j=function(){if(this.b){s(this,this.b);var e=this.getContent();if(e){"string"==typeof e&&(e=e.replace(/^\s*([\S\s]*)\b\s*$/,"$1"),e=t(this,e)),this.b.appendChild(e);var a=this;e=this.b.getElementsByTagName("IMG");for(var r,i=0;r=e[i];i++)google.maps.event.addDomListener(r,"mousedown",function(e){a.getDraggable()&&(e.preventDefault&&e.preventDefault(),e.returnValue=g)}),google.maps.event.addDomListener(r,"load",function(){a.draw()});google.maps.event.trigger(this,"domready")}this.c&&this.draw()}},e.prototype.content_changed=e.prototype.j,e.prototype.onAdd=function(){if(this.a||(this.a=document.createElement("DIV"),this.a.style.position="absolute"),this.getZIndex()&&(this.a.style.zIndex=this.getZIndex()),this.a.style.display=this.getVisible()?"":"none",!this.b){this.b=document.createElement("DIV"),this.a.appendChild(this.b);var e=this;google.maps.event.addDomListener(this.b,"click",function(){google.maps.event.trigger(e,"click")}),google.maps.event.addDomListener(this.b,"mouseover",function(){google.maps.event.trigger(e,"mouseover")}),google.maps.event.addDomListener(this.b,"mouseout",function(){google.maps.event.trigger(e,"mouseout")})}this.c=h,this.j(),this.g(),this.k();var t=this.getPanes();t&&t.overlayImage.appendChild(this.a),google.maps.event.trigger(this,"ready")},e.prototype.onAdd=e.prototype.onAdd,e.prototype.draw=function(){if(this.c&&!this.d){var e=this.getProjection();if(e){var t=this.get("position");e=e.fromLatLngToDivPixel(t),t=d(this),this.a.style.top=e.y+t.height+"px",this.a.style.left=e.x+t.width+"px",e=this.b.offsetHeight,t=this.b.offsetWidth,t!=this.get("width")&&this.set("width",t),e!=this.get("height")&&this.set("height",e)}}},e.prototype.draw=e.prototype.draw,e.prototype.onRemove=function(){this.a&&this.a.parentNode&&this.a.parentNode.removeChild(this.a),o(this)},e.prototype.onRemove=e.prototype.onRemove;var u={TOP_LEFT:1,TOP:2,TOP_RIGHT:3,LEFT:4,MIDDLE:5,RIGHT:6,BOTTOM_LEFT:7,BOTTOM:8,BOTTOM_RIGHT:9};window.RichMarkerPosition=u}(),$(function(){initSingleLevelFilters(),initDoubleLevelFilters(),initSeeAll(),initTabs(),initDeleteTerm(),initClearAll(),initTopSearch(),initAsideSearch(),initPopular(),initEventResultsCategories(),crackUrl(),pagination()});